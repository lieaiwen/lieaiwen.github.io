<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>观察者模式(订阅-发布模式) | 速度至上</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/dist/img/logo.ico">
    <link rel="manifest" href="/dist/manifest.json">
    <meta name="description" content="Reggie Study Notes">
    <link rel="preload" href="/dist/assets/css/0.styles.ad3a04d5.css" as="style"><link rel="preload" href="/dist/assets/js/app.53aea44e.js" as="script"><link rel="preload" href="/dist/assets/js/2.c8eb3e76.js" as="script"><link rel="preload" href="/dist/assets/js/55.23da1051.js" as="script"><link rel="prefetch" href="/dist/assets/js/10.99b3fe64.js"><link rel="prefetch" href="/dist/assets/js/11.c100e7aa.js"><link rel="prefetch" href="/dist/assets/js/12.f0d4a132.js"><link rel="prefetch" href="/dist/assets/js/13.bc6a69c8.js"><link rel="prefetch" href="/dist/assets/js/14.6d6162b5.js"><link rel="prefetch" href="/dist/assets/js/15.83d7aa42.js"><link rel="prefetch" href="/dist/assets/js/16.a32089be.js"><link rel="prefetch" href="/dist/assets/js/17.e3b40a13.js"><link rel="prefetch" href="/dist/assets/js/18.1014ffe8.js"><link rel="prefetch" href="/dist/assets/js/19.a37c2571.js"><link rel="prefetch" href="/dist/assets/js/20.149cc93b.js"><link rel="prefetch" href="/dist/assets/js/21.e8b8c4b3.js"><link rel="prefetch" href="/dist/assets/js/22.8de8650b.js"><link rel="prefetch" href="/dist/assets/js/23.d0e3d35b.js"><link rel="prefetch" href="/dist/assets/js/24.2a78a121.js"><link rel="prefetch" href="/dist/assets/js/25.900b32bb.js"><link rel="prefetch" href="/dist/assets/js/26.e5d2f5cd.js"><link rel="prefetch" href="/dist/assets/js/27.a4fa92c2.js"><link rel="prefetch" href="/dist/assets/js/28.7224fe30.js"><link rel="prefetch" href="/dist/assets/js/29.5c45df8b.js"><link rel="prefetch" href="/dist/assets/js/3.eccc0c92.js"><link rel="prefetch" href="/dist/assets/js/30.6dad4003.js"><link rel="prefetch" href="/dist/assets/js/31.6cc52e2a.js"><link rel="prefetch" href="/dist/assets/js/32.d071c597.js"><link rel="prefetch" href="/dist/assets/js/33.effa68bc.js"><link rel="prefetch" href="/dist/assets/js/34.39fa8140.js"><link rel="prefetch" href="/dist/assets/js/35.2939c295.js"><link rel="prefetch" href="/dist/assets/js/36.d11b50f9.js"><link rel="prefetch" href="/dist/assets/js/37.9bdbb1f2.js"><link rel="prefetch" href="/dist/assets/js/38.59c5ecd7.js"><link rel="prefetch" href="/dist/assets/js/39.a7a8037c.js"><link rel="prefetch" href="/dist/assets/js/4.acf22840.js"><link rel="prefetch" href="/dist/assets/js/40.c74438e6.js"><link rel="prefetch" href="/dist/assets/js/41.043a6787.js"><link rel="prefetch" href="/dist/assets/js/42.91479794.js"><link rel="prefetch" href="/dist/assets/js/43.5f1e6d5e.js"><link rel="prefetch" href="/dist/assets/js/44.7f595719.js"><link rel="prefetch" href="/dist/assets/js/45.e6fd0721.js"><link rel="prefetch" href="/dist/assets/js/46.62f0e57f.js"><link rel="prefetch" href="/dist/assets/js/47.53195b37.js"><link rel="prefetch" href="/dist/assets/js/48.531f119d.js"><link rel="prefetch" href="/dist/assets/js/49.482fd7b5.js"><link rel="prefetch" href="/dist/assets/js/5.712f13ff.js"><link rel="prefetch" href="/dist/assets/js/50.3b1397f7.js"><link rel="prefetch" href="/dist/assets/js/51.f896dec0.js"><link rel="prefetch" href="/dist/assets/js/52.085cb00f.js"><link rel="prefetch" href="/dist/assets/js/53.823e478a.js"><link rel="prefetch" href="/dist/assets/js/54.e850c0ec.js"><link rel="prefetch" href="/dist/assets/js/56.811da386.js"><link rel="prefetch" href="/dist/assets/js/57.c8a58ee2.js"><link rel="prefetch" href="/dist/assets/js/58.92097436.js"><link rel="prefetch" href="/dist/assets/js/59.5b3c650f.js"><link rel="prefetch" href="/dist/assets/js/6.a9728e43.js"><link rel="prefetch" href="/dist/assets/js/60.755c497b.js"><link rel="prefetch" href="/dist/assets/js/61.0779fc84.js"><link rel="prefetch" href="/dist/assets/js/62.52528737.js"><link rel="prefetch" href="/dist/assets/js/63.ae780dda.js"><link rel="prefetch" href="/dist/assets/js/64.4f4c8894.js"><link rel="prefetch" href="/dist/assets/js/65.1a99cd65.js"><link rel="prefetch" href="/dist/assets/js/66.dc0711ba.js"><link rel="prefetch" href="/dist/assets/js/67.fe4ca852.js"><link rel="prefetch" href="/dist/assets/js/68.e3350852.js"><link rel="prefetch" href="/dist/assets/js/69.f705a2d7.js"><link rel="prefetch" href="/dist/assets/js/7.6f290f44.js"><link rel="prefetch" href="/dist/assets/js/70.d5b3b9e0.js"><link rel="prefetch" href="/dist/assets/js/71.797daea0.js"><link rel="prefetch" href="/dist/assets/js/72.7bce5541.js"><link rel="prefetch" href="/dist/assets/js/73.b22a9a6b.js"><link rel="prefetch" href="/dist/assets/js/74.d2c35b89.js"><link rel="prefetch" href="/dist/assets/js/75.7e379f64.js"><link rel="prefetch" href="/dist/assets/js/76.854f4694.js"><link rel="prefetch" href="/dist/assets/js/77.0b8b3c74.js"><link rel="prefetch" href="/dist/assets/js/78.e5194eb3.js"><link rel="prefetch" href="/dist/assets/js/79.39bb4c79.js"><link rel="prefetch" href="/dist/assets/js/8.144f56e1.js"><link rel="prefetch" href="/dist/assets/js/80.c5b13a5f.js"><link rel="prefetch" href="/dist/assets/js/81.a6a1661a.js"><link rel="prefetch" href="/dist/assets/js/82.f95f29fd.js"><link rel="prefetch" href="/dist/assets/js/83.f45c0790.js"><link rel="prefetch" href="/dist/assets/js/84.3ce8f8ae.js"><link rel="prefetch" href="/dist/assets/js/85.0af8d964.js"><link rel="prefetch" href="/dist/assets/js/86.ad33b21e.js"><link rel="prefetch" href="/dist/assets/js/87.d70bb385.js"><link rel="prefetch" href="/dist/assets/js/88.fa542aee.js"><link rel="prefetch" href="/dist/assets/js/89.c26ab82e.js"><link rel="prefetch" href="/dist/assets/js/9.4375f41a.js"><link rel="prefetch" href="/dist/assets/js/90.8640bff5.js"><link rel="prefetch" href="/dist/assets/js/91.f4c9a3e7.js"><link rel="prefetch" href="/dist/assets/js/92.19bdeba2.js"><link rel="prefetch" href="/dist/assets/js/93.55d42cd8.js">
    <link rel="stylesheet" href="/dist/assets/css/0.styles.ad3a04d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/dist/" class="home-link router-link-active"><!----> <span class="site-name">速度至上</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dist/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dist/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dist/language/chinese.html" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/dist/language/english.html" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dist/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/dist/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dist/language/chinese.html" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/dist/language/english.html" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js知识点</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js杂项知识点</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>js设计模式</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dist/page-js-design/design-0/" class="sidebar-link">什么是设计模式</a></li><li><a href="/dist/page-js-design/design-1/" class="sidebar-link">工厂模式</a></li><li><a href="/dist/page-js-design/design-2/" class="sidebar-link">单例模式</a></li><li><a href="/dist/page-js-design/design-3/" class="sidebar-link">原型模式</a></li><li><a href="/dist/page-js-design/design-4/" class="sidebar-link">适配器模式</a></li><li><a href="/dist/page-js-design/design-5/" class="sidebar-link">代理模式 Proxy（代理）</a></li><li><a href="/dist/page-js-design/design-6/" class="sidebar-link">策略模式</a></li><li><a href="/dist/page-js-design/design-7/" class="sidebar-link">迭代器模式</a></li><li><a href="/dist/page-js-design/design-8/" class="active sidebar-link">观察者模式(订阅-发布模式)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/page-js-design/design-8/#观察者模式-订阅-发布模式" class="sidebar-link">观察者模式(订阅-发布模式)</a></li></ul></li><li><a href="/dist/page-js-design/design-9/" class="sidebar-link">命令模式</a></li><li><a href="/dist/page-js-design/design-10/" class="sidebar-link">状态模式</a></li><li><a href="/dist/page-js-design/design-11/" class="sidebar-link">装饰器模式</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js函数（方法）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>有待学习的</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>VUE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>es6相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>英语单词</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="观察者模式-订阅-发布模式"><a href="#观察者模式-订阅-发布模式" class="header-anchor">#</a> 观察者模式(订阅-发布模式)</h2> <p>发布-订阅模式又叫观察者模式，它定义对象间的一种一对多的依赖关系，当一个对象的状态发生
改变时，所有依赖于它的对象都将得到通知，在js开发中，我们一般用事件模型来替代传统的
发布-订阅模式。</p> <div class="language- extra-class"><pre class="language-text"><code>var observer = { //订阅者
    addSubstriber: function (callback){ // 增加子列
        this.subscribers[this.subscribers.length] = callback;
    },
    removeSubstriber: function (callback){ // 删除子列
        for(var i = 0;i&lt;this.subscribers.length;i++){
            if(this.subscribers[i] === callback){
                delete(this.subscribers[i])
            }
        }
    },
    publish:function(what){ // 发布消息
        for(var i=0;i&lt;this.subscribers.length; i++){
            if(typeof this.subscribers[i] === &quot;function&quot;){
                this.subscribers[i](what)
            }
        }
    },
    make:function(o){ // 制作 将对象转换为发布者
        for(var i in this){
            o[i] = this[i];
            o.subscribers = [];
        }
    }
}
</code></pre></div><p><a href="http://www.zliel.top/vpdemo/js-demo/js-observer/observer.html" target="_blank" rel="noopener noreferrer">demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br></p> <blockquote><p>所谓js高级程序员,第一个评判标准就是 你要掌握你工作中不常用到的知识点。
第二个呢，别人会的你得会，别人不会的你也得会。
第三个呢，不好掌握的，好的话，谁都是高级程序员了。
所以，最后呢会很苦的，你要很用功的学习和实践。</p></blockquote> <p>##vue的双向绑定原理是什么</p> <blockquote><p>vue的双向绑定是由数据劫持结合发布者－订阅者模式实现的,
通过Object.defineProperty()来劫持对象属性的setter和getter操作，在数据变动时做你想要做的事情</p></blockquote> <p>哎，这句话都看了不下十遍了,Object.defineProperty()会啊，不就是几个属性的 是否能读取，删除，遍历嘛？
js的发布，订阅模式也看了，就好比你们订阅了 我的订阅号，然后我发消息，只要订阅的人都能收到，订阅者可以被删除。
但是vue是怎么结合两者呢？让我们开始一探究竟吧！</p> <p><strong>Object.defineProperty()</strong></p> <blockquote><p>Object.defineProperty(obj, prop, descriptor)</p></blockquote> <ul><li>obj 要定义属性的对象。</li> <li>prop 要定义或修改的属性的名称。</li> <li>descriptor 要定义或修改的属性描述符。
<ol><li>writable : true || false(默认)     // 属性值可修改</li> <li>enumerable : true || false(默认)    // 属性可枚举</li> <li>configurable : true || false(默认)  // 属性可重新配置</li></ol></li></ul> <div class="language- extra-class"><pre class="language-text"><code>var obj = {}
Object.defineProperty(obj,'age',{
        value:123456,
        writable:true,
        enumerable:true,         
        configurable:true,       
    })
{age: 123456}
更简单的 来说就是 
writable:true,  obj.age = 10  // obj {age: 10}  
writable:false,  obj.age = 10  // obj {age: 123456}  
enumerable:true,  你用for in可以遍历到 属性 age 
enumerable:false,  你用for in不可以遍历到 属性 age 
configurable:true, 你就可以重新修改 上面的三个值 
如果为false  则你第一次定义的 writable enumerable 就固定了不能再修改了。
</code></pre></div><p>在接下里说一下 getter和setter方法，</p> <div class="language- extra-class"><pre class="language-text"><code>用大白话说就是 你设置我的时候 就走setter
用大白话说就是 你获取我的时候 就走getter

var book = {};
Object.defineProperty(book,'name',{
    set:function(value) {
        name = value;
        console.log('你取了一个书名叫:'+value);
    },
    get:function() {
        console.log('get方法被监听到');
        return name+'你看过？';
    }
});
设置书名
    book.name = &quot;简爱&quot;
        你取了一个书名叫:简爱
        &quot;简爱&quot;
获取书名
    book.name
         get方法被监听到
        &quot;简爱你看过？&quot;
</code></pre></div><p>ok 到这里Object.defineProperty()方法就写完了。
<strong>发布-订阅模式</strong></p> <blockquote><p>比如你订阅了报纸，然后每几天都有人 给你送报纸，你就是订阅者，报社就是发布者。</p></blockquote> <p>如何实现该模式呢？</p> <ol><li>初始化发布者和订阅者</li> <li>订阅者需要再发布者那里，登记一下，然后发布者发布消息的时候，依次下发给订阅者。</li></ol> <p>那怎么实现vue的mvvm模式的双向绑定呢？
<br> <strong>思路分析</strong></p> <p>mvvm实现双向绑定， 就是视图更新数据就更新，数据更新视图也更新。
</p><hr>
view变化更新data其实可以通过事件监听实现，比如input标签监听input事件，所有我们着重分析data变化更新view.
<hr>
data变化更新view的重点是如何知道data什么时候变化了，只要知道什么时候data变化了，那么接下来的就好处理了．这个时候我们上文提到的Object.defineProperty( )就起作用了．通过Object.defineProperty( )对属性设置一个set函数，当属性变化时就会触发这个函数，所以我们只需要将一些更新的方法放在set函数中就可以实现data变化更新view了．<p></p> <p><strong>实现过程</strong></p> <blockquote><p>我们已经知道如何实现数据的双向绑定了，　那么首先要对数据进行劫持监听，所以我们首先要设置一个监听器Observer,用来监听所有的属性，当属性变化时，就需要通知订阅者Watcher,看是否需要更新．因为属性可能是多个，所以会有多个订阅者，故我们需要一个消息订阅器Dep来专门收集这些订阅者，并在监听器Observer和订阅者Watcher之间进行统一的管理．以为在节点元素上可能存在一些指令，所以我们还需要有一个指令解析器Compile，对每个节点元素进行扫描和解析，将相关指令初始化成一个订阅者Watcher，并替换模板数据并绑定相应的函数，这时候当订阅者Watcher接受到相应属性的变化，就会执行相对应的更新函数，从而更新视图．</p></blockquote> <p>整理上面的思路，我们需要实现三个步骤，来完成双向绑定：</p> <ol><li><p>实现一个监听器Observer，用来劫持并监听所有属性，如果有变动的，就通知订阅者。</p></li> <li><p>实现一个订阅者Watcher，可以收到属性的变化通知并执行相应的函数，从而更新视图。</p></li> <li><p>实现一个解析器Compile，可以扫描和解析每个节点的相关指令，并根据初始化模板数据以及初始化相应的订阅器。</p></li></ol> <p><strong>1. 实现一个监听器Observer</strong></p> <p>数据监听器的核心方法就是Object.defineProperty( )，通过遍历循环对所有属性值进行监听，并对其进行Object.defineProperty( )处理，那么代码可以这样写：</p> <div class="language- extra-class"><pre class="language-text"><code>  function observer(data){ // 定义观察者
         if(!data || typeof data !== 'object'){ // 必须是对象
             return;
         }
         Object.keys(data).forEach(function(key){ // 遍历对象的属性 Object.keys,不包括原型上的属性
             defineReactive(data,key,data[key])  // 给每一个属性添加 响应，监听
         })
     }
     function defineReactive(data,key,val){ // 给每一个属性添加 监听
         observer(val);  // 递归监听
         Object.defineProperty(data,key,{
             enumerable:true,
             configurable:true,
             get:function(){ // 获取的时候 直接返回
                 return val;
             },
             set:function(newVal){
               val = newVal
               console.log('属性'+key+'被监听了新值是:'+newVal.toString())
             }
         })
     }
     var library = {
         book_1:{
             name:''
         },
         book_2:''
     }
     observer(library)
     library.book_1.name = 'vue书';
     library.book_2= 'js书';
     // 属性name被监听了新值是:vue书
     // 属性book_2被监听了新值是:js书
</code></pre></div><p>通过observe()方法进行遍历向下找到所有的属性，并通过defineReactive()方法进行数据劫持监听．</p> <blockquote><p>在上面的思路中，我们需要一个可以容纳消息订阅者的消息订阅器Dep，订阅器主要收集消息订阅者，然后在属性变化时执行相应订阅者的更新函数，那么消息订阅器Dep需要有一个容器，用来存放消息订阅者．我们将上面的监听器Observer稍微修改一下：</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code> function observer(data){
         if(!data || typeof data !== 'object'){
             return;
         }
         Object.keys(data).forEach(function(key){
             defineReactive(data,key,data[key])
         })
     }
     function defineReactive(data,key,val){
         observer(val);
         Object.defineProperty(data,key,{
             enumerable:true,
             configurable:true,
             get:function(){
                 if (是否需要添加订阅者) {    //Watcher初始化触发
                     dep.addSub(watcher); // 在这里添加一个订阅者
                 }
                 return val;
             },
             set:function(newVal){
                 if(val === newVal){
                    return;
                 }
               val = newVal
               console.log('属性'+key+'被监听了新值是:'+newVal.toString())
              dep.notify(); // 如果数据变化，通知所有订阅者
             }
         })
     }
     function Dep(){ // dep 容器 所有的订阅者都在这里面
         this.subs = []
     }
     Dep.prototype = {
         addSub:function(sub){
             this.subs.push(sub);
         },
         notify:function(){ // 通知
           this.subs.forEach(function(sub){
               sub.update();
             })
         }
     }
     Dep.target = null;
</code></pre></div><p>我们将订阅器Dep添加一个订阅者设计在get里面，这是为了让Watcher在初始化时触发，因此判断是否需要需要添加订阅者，
至于具体实现的方法，我们在下文中深究．在set方法中，如果函数变化，就会通知所有的订阅者，订阅者们将会执行相对应的更新函数，到目前为止，
一个比较完善的Observer已经成型了，下面我们要写订阅者Watcher</p> <p><strong>2. 实现订阅者Watcher</strong></p> <blockquote><p>根据我们的思路，订阅者Wahcher在初始化时要将自己添加到订阅器Dep中，那么如何进行添加呢？</p></blockquote> <p>我们已经知道监听器Observer是在get函数中执行了添加订阅者的操作的，所以我们只需要在订阅者Watcher在初始化时触发相对应的get函数来执行添加订阅者的操作即可．那么怎么触发对应的get函数呢？我们只需要获取对应的属性值，就可以通过Object.defineProperty( )触发对应的get了．
<br>
在这里需要注意一个细节，我们只需要在订阅者初始化时才执行添加订阅者，所以我们需要一个判断，在Dep.target上缓存一下订阅者，添加成功后去除就行了，代码如下：</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dist/page-js-design/design-7/" class="prev">
        迭代器模式
      </a></span> <span class="next"><a href="/dist/page-js-design/design-9/">
        命令模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/dist/assets/js/app.53aea44e.js" defer></script><script src="/dist/assets/js/2.c8eb3e76.js" defer></script><script src="/dist/assets/js/55.23da1051.js" defer></script>
  </body>
</html>
